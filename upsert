<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:file="http://www.mulesoft.org/schema/mule/file" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:batch="http://www.mulesoft.org/schema/mule/batch"
	xmlns:os="http://www.mulesoft.org/schema/mule/os" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/batch http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd">
	<http:request-config name="HTTP_Request_configuration" doc:name="HTTP Request configuration" doc:id="67c048f8-c064-4589-8ead-9d38a32c5e2d" >
		<http:request-connection host="mysfdcmuleproj.us-e2.cloudhub.io" />
	</http:request-config>
	<file:config name="File_Config" doc:name="File Config" doc:id="bba4c8fe-ba15-40e6-86c5-350649234d84" >
		<file:connection workingDir="/Users/Milan" />
	</file:config>
	<http:request-config name="HTTP_Request_configuration1" doc:name="HTTP Request configuration" doc:id="d7b8405f-016a-43e4-a820-599bb154bbf5" >
		<http:request-connection host="mysfdcmuleprojupsert.us-e2.cloudhub.io" />
	</http:request-config>
	<http:request-config name="HTTP_Request_configuration2" doc:name="HTTP Request configuration" doc:id="8ac4378b-ae20-4320-9249-54242d3a4269" >
		<http:request-connection protocol="HTTPS" host="kopsco.com"/>
	</http:request-config>
	<flow name="ScheduledTriggerFlow" doc:id="06eda1e9-0eed-4334-a1a1-042769df3524" >
		<scheduler doc:name="Scheduler" doc:id="0f46344e-ece1-40d8-bd9a-35d79f7eb5fb" >
			<scheduling-strategy >
				<fixed-frequency frequency="60" timeUnit="SECONDS"/>
			</scheduling-strategy>
		</scheduler>
		<flow-ref doc:name="Flow Reference" doc:id="7d750db6-c721-43b4-9615-777988d7213c" name="InvokeComplaintManagementSystem"/>
	</flow>
	<sub-flow name="InvokeComplaintManagementSystem" doc:id="bfc60e1e-8df2-4b87-8827-8b800e127990">
		<http:request method="GET" doc:name="Request" doc:id="cc3448c5-895b-421c-b0a6-011d4d95d7bd" config-ref="HTTP_Request_configuration" path="api/Complaints">
			<http:uri-params ><![CDATA[#[output application/java
---
{
	"Key" : "Value"
}]]]></http:uri-params>
			<http:query-params ><![CDATA[#[output application/java
---
{
	minRefDate : "2020-01-01",
	maxRefDate : "2020-01-02"
}]]]></http:query-params>
		</http:request>
		<logger level="INFO" doc:name="Logger" doc:id="950ee75a-e31b-4161-9e99-6e9456531ec1" message="#[payload]"/>
		<ee:transform doc:name="Transform Message" doc:id="1ec17f50-2563-44a4-8d32-7a5e60cba4a7">
						<ee:message>
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java

fun getFileName(splits) = splits[sizeOf(splits) -1]
fun splitURL(url) = getFileName(url splitBy "/") 
---
{
	reponseList: payload.complaints map((item,index) -> {
		id :  item.id,
		filedownloadlink : item.filedownloadlink , 
		bfiledownloadlink:item.bfiledownloadlink ,
		fileName:splitURL(item.filedownloadlink),
		bFileName:splitURL(item.bfiledownloadlink),
	})
}]]></ee:set-payload>
						</ee:message>
						<ee:variables>
						</ee:variables>
					</ee:transform>
		<set-payload value="#[payload.reponseList]" doc:name="Set Payload" doc:id="fef00315-e3c0-41ec-9456-301a00c4f1c0" />
		<flow-ref doc:name="Flow Reference" doc:id="79b869a1-26f8-43e4-afff-7c78379e8234" name="InvokeBatchJob" />
	</sub-flow>
	<flow name="InvokeBatchJob" doc:id="d24a78bd-81be-4d37-b162-dfd4653406e2" >
		<batch:job jobName="WriteFilesToLocalBatch_Job" doc:id="2abe1992-2f91-4c40-a973-a75588a84b1f" >
			<batch:process-records >
				<batch:step name="DownloadFiles" doc:id="9a04c9f1-b0ed-4154-8014-910221e21194" >
					<set-variable value="#[payload]" doc:name="Set Variable" doc:id="83a7222f-ea2b-4afb-82b6-9aa13d9ddcab" variableName="payloadVar"/>
					<http:request method="GET" doc:name="Request" doc:id="911b4e4f-87a8-4686-a351-ef4e18a81fce" outputMimeType="application/octet-stream" config-ref="HTTP_Request_configuration2" path="#[vars.payloadVar.filedownloadlink]"/>
					<batch:aggregator doc:name="InvokeUpsertAfterAggregation" doc:id="455a1233-27c1-4b71-9acc-bf47795a07c9" streaming="true">
						<foreach doc:name="For Each" doc:id="80edad31-a46f-4c1f-93b3-150267725fb4" >
							<logger level="INFO" doc:name="Logger" doc:id="1add9d39-8395-4818-9529-892a8208099b" message="#[vars.payloadVar]"/>
						</foreach>
					</batch:aggregator>
					<file:write doc:name="Write" doc:id="4533cd7f-cebc-4095-b72b-1313d8597d38" config-ref="File_Config" path="#[vars.payloadVar.fileName]"/>
					<http:request method="GET" doc:name="Request" doc:id="b6c560c7-5b26-449d-bee7-026e1f463a83" outputMimeType="application/octet-stream" config-ref="HTTP_Request_configuration2" path="#[vars.payloadVar.bfiledownloadlink]"/>
					<file:write doc:name="Write" doc:id="4a774809-a3f8-4826-a1f3-e6809d932109" path="#[vars.payloadVar.bFileName]" config-ref="File_Config"/>
				</batch:step>
			</batch:process-records>
		</batch:job>
	</flow>
</mule>
